# This is a basic workflow to help you get started with Actions

name: CI

# Controls when the action will run. Triggers the workflow on push or pull request
# events but only for the master branch
on:
  push:
    branches: [ master ]

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  build:
    runs-on: windows-latest
    steps:
    - name: Checkout the source code
      uses: actions/checkout@v2
      
    - name: setup-msbuild
      uses: microsoft/setup-msbuild@v1.0.1

    - name: Nuget Restore
      run: nuget restore
      
    - name: Buils the Project
      run: |
        msbuild PartsUnlimited.sln /p:TransformWebConfigEnabled=False /p:AutoParameterizationWebConfigConnectionStrings=False /p:Configuration=Release /p:Platform='Any CPU' /p:DeployOnBuild=true /p:WebPublishMethod=Package /p:PackageAsSingleFile=true /p:SkipInvalidConfigurations=true /p:PackageLocation="${{github.workspace}}\stagingdir" 
    
    - name: Upload Build Artifacts
      uses: actions/upload-artifact@2.1.0
      with:  
        name: PartsUnlimited
        path: ${{github.workspace}}\stagingdir
  
  Database:
    runs-on: db
    steps:
    - name: setup-sqlpackage
      uses: coreywebber/setup-sqlpackage@v1.0.0
      with:
        vswhere-path: 'C:\Program Files (x86)\Microsoft Visual Studio\Installer\vswhere.exe'
        
    - name: Restore the database
      run: |
        sqlpackage
#        sqlpackage /Action:Publish /SourceFile:"${{github.workspace}}\pul.dacpac" /tsn:"GANGAVALI\SQLEXPRESS" /tdn:parts /su:akshay /sp:Welcome@1234
    
        
